<!DOCTYPE html>
<html>
<head>
  <title>War Era Profitability Table</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
    }
    label {
      display: block;
      margin-top: 1rem;
      font-weight: bold;
    }
    input, button {
      width: 220px;
      padding: 0.5rem;
      margin-top: 0.5rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 2rem;
    }
    th, td {
      padding: 0.5rem;
      border: 1px solid #ccc;
      text-align: center;
    }
    th {
      background-color: #f0f0f0;
    }
    .positive {
      color: green;
    }
    .negative {
      color: red;
    }
  </style>
</head>
<body>
  <h2>War Era Profitability Table</h2>

  <label for="bonusInput">Production Bonus (%):</label>
  <input type="number" id="bonusInput" placeholder="e.g. 40">

  <label for="salaryInput">Salary per PP:</label>
  <input type="number" id="salaryInput" placeholder="e.g. 0.1">

  <div style="margin-top: 1rem;">
    <button onclick="calculateAllProfitabilities()">Calculate Profitability</button>
  </div>

  <table id="profitTable">
    <thead>
      <tr>
        <th>Item</th>
        <th>Market Source</th>
        <th>Production Source</th>
      </tr>
    </thead>
    <tbody>
      <!-- Data rows will go here -->
    </tbody>
  </table>

  <script>
    let prices = {};

    const hiddenSourceItems = ["lead", "coca", "iron", "fish", "livestock", "grain", "limestone"];

    const recipes = {
      grain: { pp: 1, materials: {} },
      coca: { pp: 1, materials: {} },
      lead: { pp: 1, materials: {} },
      iron: { pp: 1, materials: {} },
      limestone: { pp: 1, materials: {} },
      lightAmmo: { pp: 1, materials: { lead: 1 } },
      ammo: { pp: 4, materials: { lead: 4 } },
      livestock: { pp: 20, materials: {} },
      bread: { pp: 10, materials: { grain: 10 } },
      concrete: { pp: 10, materials: { limestone: 10 } },
      steel: { pp: 10, materials: { iron: 10 } },
      heavyAmmo: { pp: 16, materials: { lead: 16 } },
      steak: { pp: 20, materials: { livestock: 1 } },
      fish: { pp: 40, materials: {} },
      cookedFish: { pp: 40, materials: { fish: 1 } },
      cocain: { pp: 200, materials: { coca: 200 } }
    };

    async function loadPrices() {
      const res = await fetch('/.netlify/functions/getPrices');
      prices = await res.json();
      calculateAllProfitabilities();
    }

    function calculateAllProfitabilities() {
      const bonus = parseFloat(document.getElementById('bonusInput').value) || 0;
      const salary = parseFloat(document.getElementById('salaryInput').value);
      if (isNaN(salary)) return;

      const tbody = document.querySelector('#profitTable tbody');
      tbody.innerHTML = '';

      for (const item in recipes) {
        if (!prices[item]) continue;
        const sellPrice = prices[item];
        const recipe = recipes[item];

        const row = document.createElement('tr');
        const itemCell = document.createElement('td');
        itemCell.textContent = item;
        row.appendChild(itemCell);

        // Market Source Calculation (only if item has materials)
        const marketCell = document.createElement('td');
        if (Object.keys(recipe.materials).length > 0) {
          const marketProfit = calculateProfitability(item, bonus, salary, 'market');
          marketCell.textContent = marketProfit !== null ? (marketProfit * 100).toFixed(2) + '%' : '—';
          marketCell.className = marketProfit > 0 ? 'positive' : 'negative';
        } else {
          marketCell.textContent = '—';
        }
        row.appendChild(marketCell);

        // Production Source Calculation
        const prodProfit = calculateProfitability(item, bonus, salary, 'production');
        const prodCell = document.createElement('td');
        prodCell.textContent = prodProfit !== null ? (prodProfit * 100).toFixed(2) + '%' : '—';
        prodCell.className = prodProfit > 0 ? 'positive' : 'negative';
        row.appendChild(prodCell);

        tbody.appendChild(row);
      }
    }

    function calculateProfitability(item, bonus, salary, source) {
      const recipe = recipes[item];
      const sellPrice = prices[item];
      if (!recipe || !sellPrice || sellPrice <= 0) return null;

      if (Object.keys(recipe.materials).length === 0) {
        const pp = recipe.pp / (1 + bonus / 100);
        const cost = pp * salary;
        return (sellPrice - cost) / cost;
      }

      if (source === 'market') {
        let matCost = 0;
        for (const [mat, qty] of Object.entries(recipe.materials)) {
          if (!prices[mat]) return null;
          matCost += prices[mat] * qty;
        }
        const pp = recipe.pp / (1 + bonus / 100);
        const cost = matCost + pp * salary;
        return (sellPrice - cost) / cost;
      }

      if (source === 'production') {
        const totalPP = calculatePPTotal(item, bonus);
        if (totalPP === null) return null;
        const pp = totalPP / (1 + bonus / 100);
        const cost = pp * salary;
        return (sellPrice - cost) / cost;
      }

      return null;
    }

    function calculatePPTotal(item, bonus) {
      const recipe = recipes[item];
      if (!recipe) return null;
      let totalPP = recipe.pp;
      for (const [mat, qty] of Object.entries(recipe.materials)) {
        const subPP = calculatePPTotal(mat, bonus);
        if (subPP === null) return null;
        totalPP += subPP * qty;
      }
      return totalPP;
    }

    loadPrices();
  </script>
</body>
</html>
