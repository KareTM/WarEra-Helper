<!DOCTYPE html>
<html>
<head>
  <title>War Era Price Tool</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
    }
    label {
      display: block;
      margin-top: 1rem;
      font-weight: bold;
    }
    input, select, button {
      width: 220px;
      padding: 0.5rem;
      margin-top: 0.5rem;
    }
    #priceDisplay, #resultDisplay {
      margin-top: 1rem;
      font-size: 1.2rem;
      font-weight: bold;
    }
    #sourceWrapper {
      display: none;
    }
    #resultDisplay.error {
      color: red;
    }
    #resultDisplay.success {
      color: green;
    }
    #materialsInfo {
      margin-top: 1rem;
      font-style: italic;
    }
  </style>
</head>
<body>
  <h2>War Era Price Tool</h2>

  <label for="itemSelect">Select item:</label>
  <select id="itemSelect">
    <option value="">-- Choose an item --</option>
  </select>

  <div id="sourceWrapper">
    <label for="sourceSelect">Input item source:</label>
    <select id="sourceSelect">
      <option value="market">Market</option>
      <option value="production">Production</option>
    </select>
  </div>

  <label for="bonusInput">Production Bonus (%):</label>
  <input type="number" id="bonusInput" placeholder="e.g. 25">

  <label for="salaryInput">Salary per PP:</label>
  <input type="number" id="salaryInput" placeholder="e.g. 1.2">

  <div id="priceDisplay">Sell price: —</div>
  <div id="materialsInfo"></div>

  <button onclick="calculateProfitability()">Calculate Profitability</button>
  <div id="resultDisplay">Profitability: —</div>

  <script>
    let prices = {};
    const hiddenSourceItems = ["lead", "coca", "iron", "fish", "livestock", "grain", "limestone"];

    const recipes = {
      grain: { pp: 1, materials: {} },
      coca: { pp: 1, materials: {} },
      lead: { pp: 1, materials: {} },
      iron: { pp: 1, materials: {} },
      limestone: { pp: 1, materials: {} },
      lightAmmo: { pp: 1, materials: { lead: 1 } },
      ammo: { pp: 4, materials: { lead: 4 } },
      livestock: { pp: 20, materials: {} },
      bread: { pp: 10, materials: { grain: 10 } },
      concrete: { pp: 10, materials: { limestone: 10 } },
      steel: { pp: 10, materials: { iron: 10 } },
      heavyAmmo: { pp: 16, materials: { lead: 16 } },
      steak: { pp: 20, materials: { livestock: 1 } },
      fish: { pp: 40, materials: {} },
      cookedFish: { pp: 40, materials: { fish: 1 } },
      cocain: { pp: 200, materials: { coca: 200 } }
    };

    async function loadPrices() {
      const res = await fetch('/.netlify/functions/getPrices');
      prices = await res.json();

      const select = document.getElementById('itemSelect');
      const sortedItems = Object.entries(prices)
        .filter(([item]) => item !== "case1")
        .sort((a, b) => a[1] - b[1]);

      for (const [item, price] of sortedItems) {
        const option = document.createElement('option');
        option.value = item;
        option.textContent = item;
        select.appendChild(option);
      }
    }

    document.getElementById('itemSelect').addEventListener('change', () => {
      updateSellPrice();
      updateSourceVisibility();
      showMaterialInfo();
      clearResult();
    });

    document.getElementById('sourceSelect').addEventListener('change', () => {
      showMaterialInfo();
    });

    function updateSellPrice() {
      const selectedItem = document.getElementById('itemSelect').value;
      const price = prices[selectedItem];
      const display = document.getElementById('priceDisplay');
      if (price !== undefined) {
        display.textContent = `Sell price: ${price.toFixed(3)}`;
      } else {
        display.textContent = 'Sell price: —';
      }
    }

    function updateSourceVisibility() {
      const selectedItem = document.getElementById('itemSelect').value;
      const sourceWrapper = document.getElementById('sourceWrapper');
      if (hiddenSourceItems.includes(selectedItem)) {
        sourceWrapper.style.display = 'none';
      } else {
        sourceWrapper.style.display = 'block';
      }
    }

    function showMaterialInfo() {
      const selectedItem = document.getElementById('itemSelect').value;
      const sourceValue = document.getElementById('sourceSelect').value;
      const materialsDiv = document.getElementById('materialsInfo');
      materialsDiv.innerHTML = '';
    
      const recipe = recipes[selectedItem];
      if (!recipe) return;
    
      const bonusStr = document.getElementById('bonusInput').value;
      const bonus = parseFloat(bonusStr) || 0;
    
      const getAdjustedPP = (pp) => pp / (1 + bonus / 100);
      const displayPP = (pp) => Math.round(getAdjustedPP(pp));
    
      const list = document.createElement('ul');
      let totalPP = getAdjustedPP(recipe.pp);
    
      for (const [mat, qty] of Object.entries(recipe.materials)) {
        const matRecipe = recipes[mat];
        const matLi = document.createElement('li');
    
        if (sourceValue === 'market') {
          const matPrice = prices[mat];
          const ppCost = matRecipe ? qty * getAdjustedPP(matRecipe.pp) : 0;
          matLi.textContent = `${qty} × ${mat} @ ${matPrice?.toFixed(3) ?? '—'} — PP cost: ${Math.round(ppCost)}`;
          totalPP += ppCost;
        } else if (sourceValue === 'production') {
          if (matRecipe) {
            const ppCost = qty * getAdjustedPP(matRecipe.pp);
            matLi.textContent = `${qty} × ${mat} (produced) — PP cost: ${Math.round(ppCost)}`;
            totalPP += ppCost;
          } else {
            matLi.textContent = `${qty} × ${mat} (PP only)`;
          }
        }
    
        list.appendChild(matLi);
      }
    
      materialsDiv.innerHTML = '<strong>Required input materials:</strong>';
      materialsDiv.appendChild(list);
    
      const ppInfo = document.createElement('p');
      ppInfo.innerHTML = `<strong>Total PP cost:</strong> ${Math.round(totalPP)}`;
      materialsDiv.appendChild(ppInfo);
    }

    function calculatePPCost(itemName, productionBonus, salaryPP) {
      const recipe = recipes[itemName];
      if (!recipe) return null;

      let basePP = recipe.pp / (1 + productionBonus / 100);
      let materialsPPCost = 0;

      for (const [mat, qty] of Object.entries(recipe.materials)) {
        const matPPCost = calculatePPCost(mat, productionBonus, salaryPP);
        if (matPPCost === null) return null;
        materialsPPCost += matPPCost * qty;
      }

      return basePP + materialsPPCost;
    }

    function calculateProfitability() {
      clearResult();
    
      const resultDiv = document.getElementById('resultDisplay');
      resultDiv.classList.remove('error', 'success');
    
      const item = document.getElementById('itemSelect').value;
      const bonusStr = document.getElementById('bonusInput').value;
      const salaryStr = document.getElementById('salaryInput').value;
      const source = document.getElementById('sourceSelect').value;
    
      if (!item) return showError('Please select an item.');
      if (bonusStr === '' || salaryStr === '') return showError('Production Bonus and Salary per PP are required.');
    
      const bonus = parseFloat(bonusStr);
      const salary = parseFloat(salaryStr);
      if (isNaN(bonus) || isNaN(salary)) return showError('Bonus and Salary must be valid numbers.');
    
      const sellPrice = prices[item];
      if (!sellPrice || sellPrice <= 0) return showError('Invalid sell price.');
    
      const recipe = recipes[item];
      if (!recipe) return showError('Recipe not found.');
    
      let profitability;
    
      // Case 1: Only PP needed
      if (Object.keys(recipe.materials).length === 0) {
        const ppNeeded = recipe.pp / (1 + bonus / 100);
        const ppCost = ppNeeded * salary;
        profitability = (sellPrice - ppCost) / sellPrice;
    
      // Case 2: Materials needed, bought from Market
      } else if (source === 'market') {
        const ppNeeded = recipe.pp / (1 + bonus / 100);
        let materialsCost = 0;
        for (const [mat, qty] of Object.entries(recipe.materials)) {
          const matPrice = prices[mat];
          if (!matPrice) return showError(`Missing market price for "${mat}".`);
          materialsCost += matPrice * qty;
        }
        const totalCost = ppNeeded * salary + materialsCost;
        profitability = (sellPrice - totalCost) / sellPrice;
    
      // Case 3: Materials needed, self-produced
      } else if (source === 'production') {
        const ppCostTotal = calculatePPCost(item, bonus, salary);
        if (ppCostTotal === null) return showError('PP cost calculation failed.');
        const totalCost = ppCostTotal * salary;
        profitability = (sellPrice - totalCost) / sellPrice;
    
      } else {
        return showError('Invalid input source.');
      }
    
      showSuccess(`Profitability: ${(profitability * 100).toFixed(2)}%`);
    }

    function showError(msg) {
      const resultDiv = document.getElementById('resultDisplay');
      resultDiv.textContent = msg;
      resultDiv.classList.add('error');
    }

    function showSuccess(msg) {
      const resultDiv = document.getElementById('resultDisplay');
      resultDiv.textContent = msg;
      resultDiv.classList.add('success');
    }

    function clearResult() {
      const resultDiv = document.getElementById('resultDisplay');
      resultDiv.textContent = 'Profitability: —';
      resultDiv.classList.remove('error', 'success');
    }

    loadPrices();
  </script>
</body>
</html>
