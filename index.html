<!DOCTYPE html>
<html>
<head>
  <title>War Era Profitability Table</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
    }
    label {
      display: block;
      margin-top: 1rem;
      font-weight: bold;
    }
    input, button {
      width: 220px;
      padding: 0.5rem;
      margin-top: 0.5rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 2rem;
    }
    th, td {
      padding: 0.5rem;
      border: 1px solid #ccc;
      text-align: center;
    }
    th {
      background-color: #f0f0f0;
    }
    .positive {
      color: green;
    }
    .negative {
      color: red;
    }
    .dark-gray { color: #333; }
    .dark-green { color: darkgreen; }
    .dark-blue { color: darkblue; }
    .purple { color: purple; }
  </style>
</head>
<body>
  <h2>War Era Profitability Table</h2>

  <label for="bonusInput">Production Bonus (%):</label>
  <input type="number" id="bonusInput" placeholder="e.g. 25">

  <label for="salaryInput">Salary per PP:</label>
  <input type="number" id="salaryInput" placeholder="e.g. 1.2">

  <div style="margin-top: 1rem;">
    <button onclick="calculateAllProfitabilities()">Calculate Profitability</button>
  </div>

  <table id="profitTable">
    <thead>
      <tr>
        <th>Item</th>
        <th>Market Source</th>
        <th>Production Source</th>
      </tr>
    </thead>
    <tbody>
      <!-- Data rows will go here -->
    </tbody>
  </table>

  <script>
    let prices = {};

    const itemDisplayOrder = [
      { id: 'lead', label: 'Lead', class: 'dark-gray' },
      { id: 'coca', label: 'Mysterious plant', class: 'dark-gray' },
      { id: 'iron', label: 'Iron', class: 'dark-gray' },
      { id: 'fish', label: 'Fish', class: 'dark-gray' },
      { id: 'livestock', label: 'Livestock', class: 'dark-gray' },
      { id: 'grain', label: 'Grain', class: 'dark-gray' },
      { id: 'limestone', label: 'Limestone', class: 'dark-gray' },
      { id: 'lightAmmo', label: 'Light ammo', class: 'dark-green' },
      { id: 'bread', label: 'Bread', class: 'dark-green' },
      { id: 'steel', label: 'Steel', class: 'dark-green' },
      { id: 'concrete', label: 'Concrete', class: 'dark-green' },
      { id: 'ammo', label: 'Ammo', class: 'dark-blue' },
      { id: 'steak', label: 'Steak', class: 'dark-blue' },
      { id: 'heavyAmmo', label: 'Heavy ammo', class: 'purple' },
      { id: 'cocain', label: 'Pill', class: 'purple' },
      { id: 'cookedFish', label: 'Cooked fish', class: 'purple' }
    ];

    const recipes = {
      grain: { pp: 1, materials: {} },
      coca: { pp: 1, materials: {} },
      lead: { pp: 1, materials: {} },
      iron: { pp: 1, materials: {} },
      limestone: { pp: 1, materials: {} },
      lightAmmo: { pp: 1, materials: { lead: 1 } },
      ammo: { pp: 4, materials: { lead: 4 } },
      livestock: { pp: 20, materials: {} },
      bread: { pp: 10, materials: { grain: 10 } },
      concrete: { pp: 10, materials: { limestone: 10 } },
      steel: { pp: 10, materials: { iron: 10 } },
      heavyAmmo: { pp: 16, materials: { lead: 16 } },
      steak: { pp: 20, materials: { livestock: 1 } },
      fish: { pp: 40, materials: {} },
      cookedFish: { pp: 40, materials: { fish: 1 } },
      cocain: { pp: 200, materials: { coca: 200 } }
    };

    async function loadPrices() {
      const res = await fetch('/.netlify/functions/getPrices');
      prices = await res.json();
      calculateAllProfitabilities();
    }

    function calculateAllProfitabilities() {
      const bonus = parseFloat(document.getElementById('bonusInput').value) || 0;
      const salary = parseFloat(document.getElementById('salaryInput').value);
      if (isNaN(salary)) return;

      const tbody = document.querySelector('#profitTable tbody');
      tbody.innerHTML = '';

      for (const { id, label, class: colorClass } of itemDisplayOrder) {
        if (!prices[id]) continue;
        const sellPrice = prices[id];
        const recipe = recipes[id];

        const row = document.createElement('tr');
        const itemCell = document.createElement('td');
        itemCell.textContent = label;
        itemCell.className = colorClass;
        row.appendChild(itemCell);

        const marketCell = document.createElement('td');
        if (Object.keys(recipe.materials).length > 0) {
          const marketProfit = calculateProfitability(id, bonus, salary, 'market');
          marketCell.textContent = marketProfit !== null ? (marketProfit * 100).toFixed(2) + '%' : '—';
          marketCell.className = marketProfit > 0 ? 'positive' : 'negative';
        } else {
          marketCell.textContent = '—';
        }
        row.appendChild(marketCell);

        const prodProfit = calculateProfitability(id, bonus, salary, 'production');
        const prodCell = document.createElement('td');
        prodCell.textContent = prodProfit !== null ? (prodProfit * 100).toFixed(2) + '%' : '—';
        prodCell.className = prodProfit > 0 ? 'positive' : 'negative';
        row.appendChild(prodCell);

        tbody.appendChild(row);
      }
    }

    function calculateProfitability(item, bonus, salary, source) {
      const recipe = recipes[item];
      const sellPrice = prices[item];
      if (!recipe || !sellPrice || sellPrice <= 0) return null;

      if (Object.keys(recipe.materials).length === 0) {
        const pp = recipe.pp / (1 + bonus / 100);
        const cost = pp * salary;
        return (sellPrice - cost) / cost;
      }

      if (source === 'market') {
        let matCost = 0;
        for (const [mat, qty] of Object.entries(recipe.materials)) {
          if (!prices[mat]) return null;
          matCost += prices[mat] * qty;
        }
        const pp = recipe.pp / (1 + bonus / 100);
        const cost = matCost + pp * salary;
        return (sellPrice - cost) / cost;
      }

      if (source === 'production') {
        const basePP = recipe.pp / (1 + bonus / 100);
        let matPP = 0;
        for (const [mat, qty] of Object.entries(recipe.materials)) {
          const subTotal = calculatePPTotal(mat);
          if (subTotal === null) return null;
          matPP += subTotal * qty;
        }
        const totalPP = basePP + matPP;
        const cost = totalPP * salary;
        return (sellPrice - cost) / cost;
      }

      return null;
    }

    function calculatePPTotal(item) {
      const recipe = recipes[item];
      if (!recipe) return null;
      let totalPP = recipe.pp;
      for (const [mat, qty] of Object.entries(recipe.materials)) {
        const subPP = calculatePPTotal(mat);
        if (subPP === null) return null;
        totalPP += subPP * qty;
      }
      return totalPP;
    }

    loadPrices();
  </script>
</body>
</html>
